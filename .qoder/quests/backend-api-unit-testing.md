# 后端 API 单元测试设计文档

## 1. 概述

### 1.1 设计目标

为年会抽奖系统后端的所有 API 接口创建全面的单元测试，确保代码质量、功能正确性和系统稳定性。

### 1.2 测试范围

需要为以下三个控制器的所有接口方法创建单元测试：

- AuthController：认证授权相关接口（5个接口）
- LotteryController：抽奖管理相关接口（20个接口）
- TenantController：租户管理相关接口（3个接口）

### 1.3 测试策略

采用分层测试策略，重点覆盖以下层次：

- Controller 层：测试 HTTP 请求处理、参数验证、响应格式
- Service 层：测试业务逻辑正确性、异常处理
- 集成测试：测试完整的请求响应流程（可选）

## 2. 技术方案

### 2.1 测试框架选型

| 框架/工具 | 用途 | 版本 |
|---------|------|------|
| JUnit 5 | 测试框架基础 | Spring Boot 3.2.11 自带 |
| Mockito | Mock 对象创建 | Spring Boot 3.2.11 自带 |
| MockMvc | Controller 层测试 | Spring Boot 3.2.11 自带 |
| Spring Boot Test | 测试支持和自动配置 | 3.2.11 |
| Spring Security Test | 安全相关测试 | 已引入 |
| AssertJ | 流式断言 | Spring Boot 3.2.11 自带 |
| H2 Database | 测试用内存数据库 | 需要添加 |
| Testcontainers | 容器化测试（可选） | 可选引入 |

### 2.2 依赖配置

需要在 pom.xml 中添加的测试依赖：

| 依赖 | 说明 | 作用域 |
|-----|------|--------|
| H2 Database | 内存数据库，替代测试中的 PostgreSQL | test |
| MockServer（可选） | 模拟外部服务 | test |

### 2.3 测试配置

需要创建测试专用配置：

| 配置文件 | 用途 |
|---------|------|
| application-test.yml | 测试环境配置（数据库、Redis 等） |
| test-data.sql | 测试数据初始化脚本 |

配置要点：

- 使用 H2 内存数据库替代 PostgreSQL
- 禁用 Redis 或使用嵌入式 Redis
- 禁用不必要的自动配置
- 配置合适的日志级别

## 3. 测试用例设计

### 3.1 AuthController 测试用例

#### 3.1.1 POST /auth/login - 用户登录

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常登录 | 有效用户名和密码 | 返回 token 和用户信息 | 状态码 200，响应包含 token 和 userInfo |
| 用户名不存在 | 不存在的用户名 | 返回错误信息 | 状态码 401，错误消息正确 |
| 密码错误 | 正确用户名，错误密码 | 返回错误信息 | 状态码 401，错误消息正确 |
| 参数校验失败 | 空用户名或密码 | 返回参数校验错误 | 状态码 400，错误消息正确 |
| 租户不存在 | 不存在的租户代码 | 返回错误信息 | 状态码 404，错误消息正确 |

#### 3.1.2 POST /auth/register - 租户注册

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常注册 | 完整注册信息 | 返回租户信息 | 状态码 200，租户信息完整 |
| 租户代码重复 | 已存在的租户代码 | 返回错误信息 | 状态码 409，错误消息正确 |
| 参数校验失败 | 缺少必填字段 | 返回参数校验错误 | 状态码 400，错误消息正确 |
| Schema 创建失败 | 模拟数据库异常 | 返回错误信息 | 状态码 500，事务回滚 |

#### 3.1.3 POST /auth/logout - 用户登出

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常登出 | 有效的认证信息 | 返回成功 | 状态码 200，Redis 中 token 失效 |
| 未认证 | 无 token | 返回未认证错误 | 状态码 401 |

#### 3.1.4 GET /auth/current - 获取当前用户信息

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 有效的认证信息 | 返回用户详情 | 状态码 200，用户信息完整 |
| 未认证 | 无 token | 返回未认证错误 | 状态码 401 |
| 用户不存在 | 有效 token 但用户已删除 | 返回错误信息 | 状态码 404 |

#### 3.1.5 POST /auth/refresh - 刷新 Token

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常刷新 | 有效的旧 token | 返回新 token | 状态码 200，新 token 有效 |
| Token 过期 | 过期的 token | 返回错误信息 | 状态码 401 |
| Token 无效 | 格式错误的 token | 返回错误信息 | 状态码 401 |

### 3.2 LotteryController 测试用例

#### 3.2.1 GET /lottery/activities/{activityId}/data - 获取抽奖初始化数据

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 存在的活动 ID | 返回完整抽奖数据 | 状态码 200，包含活动、奖项、参与人员、中奖记录 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |
| 跨租户访问 | 其他租户的活动 ID | 返回空或错误 | 租户隔离生效 |

#### 3.2.2 POST /lottery/winners - 保存中奖记录

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常保存 | 有效的中奖信息 | 返回中奖记录 | 状态码 200，记录保存成功 |
| 参与人员已中奖 | 已中奖的参与人员 | 返回错误信息 | 状态码 409 |
| 奖项已抽完 | 数量已满的奖项 | 返回错误信息 | 状态码 409 |
| 参数校验失败 | 缺少必填字段 | 返回参数校验错误 | 状态码 400 |

#### 3.2.3 GET /lottery/activities/{activityId}/winners - 查询中奖记录列表

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常查询 | 存在的活动 ID | 返回中奖记录列表 | 状态码 200，列表数据正确 |
| 无中奖记录 | 未开始抽奖的活动 | 返回空列表 | 状态码 200，空数组 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.4 POST /lottery/activities/{activityId}/reset - 重置抽奖

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常重置 | 存在的活动 ID | 返回成功 | 状态码 200，中奖记录清空 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |
| 权限不足（可选） | 非 ADMIN 用户 | 返回权限错误 | 状态码 403 |

#### 3.2.5 GET /lottery/activities - 获取活动列表

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 有效认证信息 | 返回活动列表 | 状态码 200，仅返回当前租户的活动 |
| 租户无活动 | 新租户 | 返回空列表 | 状态码 200，空数组 |

#### 3.2.6 GET /lottery/activities/{activityId} - 获取活动详情

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 存在的活动 ID | 返回活动详情 | 状态码 200，详情完整 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.7 POST /lottery/activities - 创建活动

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常创建 | 完整活动信息 | 返回创建的活动 | 状态码 200，活动信息正确 |
| 参数校验失败 | 缺少必填字段 | 返回参数校验错误 | 状态码 400 |
| 日期格式错误 | 无效的日期时间 | 返回错误信息 | 状态码 400 |

#### 3.2.8 PUT /lottery/activities/{activityId} - 更新活动

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常更新 | 有效的活动信息 | 返回更新后的活动 | 状态码 200，更新成功 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |
| 活动已开始 | 尝试修改已开始的活动 | 返回错误信息（可选） | 状态码 409 |

#### 3.2.9 GET /lottery/activities/{activityId}/prizes - 获取奖项列表

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 存在的活动 ID | 返回奖项列表 | 状态码 200，列表数据正确 |
| 无奖项 | 新创建的活动 | 返回空列表 | 状态码 200，空数组 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.10 POST /lottery/prizes - 创建奖项

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常创建 | 完整奖项信息 | 返回创建的奖项 | 状态码 200，奖项信息正确 |
| 参数校验失败 | 数量为负数 | 返回参数校验错误 | 状态码 400 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.11 PUT /lottery/prizes/{prizeId} - 更新奖项

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常更新 | 有效的奖项信息 | 返回更新后的奖项 | 状态码 200，更新成功 |
| 奖项不存在 | 不存在的奖项 ID | 返回错误信息 | 状态码 404 |
| 已抽取的奖项 | 减少已抽取奖项的数量 | 返回错误信息 | 状态码 409 |

#### 3.2.12 DELETE /lottery/prizes/{prizeId} - 删除奖项

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常删除 | 未抽取的奖项 ID | 返回成功 | 状态码 200，奖项删除 |
| 已抽取的奖项 | 已有中奖记录的奖项 | 返回错误信息 | 状态码 409 |
| 奖项不存在 | 不存在的奖项 ID | 返回错误信息 | 状态码 404 |

#### 3.2.13 GET /lottery/activities/{activityId}/participants - 获取参会人员列表

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 存在的活动 ID | 返回参会人员列表 | 状态码 200，列表数据正确 |
| 无参会人员 | 新创建的活动 | 返回空列表 | 状态码 200，空数组 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.14 POST /lottery/participants - 添加参会人员

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常添加 | 完整参会人员信息 | 返回创建的参会人员 | 状态码 200，信息正确 |
| 参数校验失败 | 缺少姓名 | 返回参数校验错误 | 状态码 400 |
| 活动不存在 | 不存在的活动 ID | 返回错误信息 | 状态码 404 |

#### 3.2.15 PUT /lottery/participants/{participantId} - 更新参会人员

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常更新 | 有效的参会人员信息 | 返回更新后的参会人员 | 状态码 200，更新成功 |
| 参会人员不存在 | 不存在的参会人员 ID | 返回错误信息 | 状态码 404 |

#### 3.2.16 DELETE /lottery/participants/{participantId} - 删除参会人员

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常删除 | 未中奖的参会人员 ID | 返回成功 | 状态码 200，参会人员删除 |
| 已中奖的参会人员 | 已中奖的参会人员 ID | 返回错误信息 | 状态码 409 |
| 参会人员不存在 | 不存在的参会人员 ID | 返回错误信息 | 状态码 404 |

### 3.3 TenantController 测试用例

#### 3.3.1 GET /admin/tenants - 获取租户列表

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常获取 | 超级管理员认证信息 | 返回所有租户列表 | 状态码 200，列表完整 |
| 权限不足（可选） | 普通用户认证信息 | 返回权限错误 | 状态码 403 |
| 未认证 | 无 token | 返回未认证错误 | 状态码 401 |

#### 3.3.2 POST /admin/tenants - 创建租户

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常创建 | 完整租户信息 | 返回创建的租户 | 状态码 200，Schema 创建成功 |
| 租户代码重复 | 已存在的租户代码 | 返回错误信息 | 状态码 409 |
| 参数校验失败 | 缺少必填字段 | 返回参数校验错误 | 状态码 400 |
| Schema 创建失败 | 模拟数据库异常 | 返回错误信息 | 状态码 500，事务回滚 |

#### 3.3.3 PUT /admin/tenants/{tenantId} - 更新租户

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 正常更新 | 有效的租户信息 | 返回更新后的租户 | 状态码 200，更新成功 |
| 租户不存在 | 不存在的租户 ID | 返回错误信息 | 状态码 404 |
| 租户代码重复 | 修改为已存在的代码 | 返回错误信息 | 状态码 409 |

## 4. 测试实现策略

### 4.1 测试基类设计

创建测试基类以减少重复代码：

| 基类名称 | 用途 | 提供功能 |
|---------|------|---------|
| BaseControllerTest | Controller 层测试基类 | MockMvc 配置、通用断言方法 |
| BaseServiceTest | Service 层测试基类 | Mock 配置、测试数据准备 |
| IntegrationTestBase | 集成测试基类 | 完整上下文加载、数据库初始化 |

### 4.2 Mock 策略

| 层次 | Mock 对象 | 说明 |
|-----|----------|------|
| Controller 测试 | Service 层 | 使用 @MockBean 模拟 Service |
| Service 测试 | Mapper 层、外部依赖 | 使用 @Mock 模拟数据访问层 |
| 集成测试 | 外部服务 | 使用真实数据库，模拟外部 API |

### 4.3 测试数据准备

数据准备策略：

| 方法 | 适用场景 | 说明 |
|-----|---------|------|
| @BeforeEach 方法 | 每个测试需要的数据 | 在每个测试方法前执行 |
| @BeforeAll 方法 | 所有测试共享的数据 | 在测试类初始化时执行一次 |
| SQL 脚本 | 数据库初始化 | 使用 @Sql 注解加载 |
| Builder 模式 | 复杂对象构建 | 创建测试数据构建器 |

### 4.4 断言策略

使用 AssertJ 进行流式断言：

| 断言类型 | 示例场景 |
|---------|---------|
| 状态码断言 | 验证 HTTP 响应状态 |
| 响应体断言 | 验证返回的 JSON 数据结构和内容 |
| 异常断言 | 验证异常类型和消息 |
| Mock 调用断言 | 验证 Mock 对象的方法调用次数和参数 |

## 5. 测试环境配置

### 5.1 测试配置文件结构

```
src/test/resources/
├── application-test.yml           # 测试环境主配置
├── test-data.sql                  # 测试数据初始化
└── schema.sql                     # 测试数据库 Schema
```

### 5.2 测试配置要点

#### 5.2.1 数据库配置

- 使用 H2 内存数据库
- 配置为 PostgreSQL 兼容模式
- 每次测试后自动清理数据

#### 5.2.2 Security 配置

- 提供测试用的 JWT 密钥
- 简化认证流程便于测试
- 支持模拟不同角色的用户

#### 5.2.3 Redis 配置

- 使用嵌入式 Redis 或完全 Mock
- 避免依赖外部 Redis 服务

#### 5.2.4 多租户配置

- 配置测试租户的 Schema
- 支持租户隔离测试

### 5.3 测试数据准备

需要准备的测试数据：

| 数据类型 | 数量 | 说明 |
|---------|------|------|
| 租户数据 | 2-3 个 | 测试租户隔离 |
| 用户数据 | 每租户 3-5 个 | 不同角色的用户 |
| 活动数据 | 每租户 2-3 个 | 不同状态的活动 |
| 奖项数据 | 每活动 3-5 个 | 不同类型的奖项 |
| 参会人员数据 | 每活动 10-20 个 | 部分已中奖、部分未中奖 |
| 中奖记录数据 | 部分活动 | 测试各种中奖场景 |

## 6. 测试执行计划

### 6.1 测试执行阶段

| 阶段 | 任务 | 预期结果 |
|-----|------|---------|
| 阶段 1：环境准备 | 添加依赖、创建配置文件 | 测试环境可运行 |
| 阶段 2：基础设施 | 创建测试基类、工具类 | 测试框架就绪 |
| 阶段 3：Controller 测试 | 实现所有 Controller 测试 | Controller 层测试覆盖 100% |
| 阶段 4：Service 测试 | 实现所有 Service 测试 | Service 层测试覆盖 80%+ |
| 阶段 5：问题修复 | 执行测试并修复发现的问题 | 所有测试通过 |
| 阶段 6：报告生成 | 生成测试覆盖率报告 | 提供测试质量报告 |

### 6.2 测试执行方式

| 执行方式 | 命令 | 说明 |
|---------|------|------|
| 执行所有测试 | mvn test | Maven 命令执行 |
| 执行单个测试类 | mvn test -Dtest=类名 | 指定测试类 |
| 生成覆盖率报告 | mvn test jacoco:report | 使用 JaCoCo 插件 |
| IDE 执行 | 右键运行 | IntelliJ IDEA / Eclipse |

### 6.3 测试覆盖率目标

| 层次 | 目标覆盖率 | 说明 |
|-----|-----------|------|
| Controller 层 | 100% | 所有接口方法必须覆盖 |
| Service 层 | 85%+ | 核心业务逻辑必须覆盖 |
| Util 工具类 | 90%+ | 工具方法充分测试 |
| 总体覆盖率 | 80%+ | 整体代码质量保证 |

## 7. 问题预期与修复策略

### 7.1 常见问题类型

| 问题类型 | 可能原因 | 修复策略 |
|---------|---------|---------|
| 参数校验缺失 | 未添加 @Valid 注解 | 添加参数校验注解 |
| 异常处理不当 | 未捕获特定异常 | 完善异常处理逻辑 |
| 空指针异常 | 未判空 | 添加空值检查 |
| 租户隔离失效 | 未正确设置租户上下文 | 修复租户拦截器 |
| 并发问题 | 缺少事务或锁 | 添加事务控制 |
| 数据不一致 | 缺少数据库约束 | 添加唯一索引等约束 |

### 7.2 修复优先级

| 优先级 | 问题严重程度 | 处理方式 |
|-------|-------------|---------|
| P0 | 核心功能无法使用 | 立即修复 |
| P1 | 安全问题、数据丢失风险 | 优先修复 |
| P2 | 功能异常但有替代方案 | 计划修复 |
| P3 | 体验问题、边界情况 | 视情况修复 |

### 7.3 回归测试策略

修复问题后的验证：

- 重新执行失败的测试用例
- 执行相关模块的所有测试
- 执行完整的测试套件
- 检查测试覆盖率是否提升

## 8. 测试维护策略

### 8.1 测试代码规范

- 测试方法命名：使用 should_期望结果_when_条件 格式
- 测试数据：使用有意义的测试数据，避免魔法数字
- 注释：为复杂的测试场景添加注释说明
- 断言：每个测试应有明确的断言，避免无断言测试

### 8.2 测试用例维护

- 代码变更时同步更新测试
- 定期审查测试用例的有效性
- 删除无效或重复的测试
- 重构测试代码消除重复

### 8.3 持续集成

- 将测试集成到 CI/CD 流程
- 代码提交前必须通过所有测试
- 定期生成测试报告和覆盖率报告
- 监控测试执行时间，优化慢测试

## 9. 验收标准

### 9.1 功能验收

- 所有 28 个 API 接口都有对应的测试用例
- 每个接口至少覆盖 3 种测试场景（正常、异常、边界）
- 所有测试用例执行通过

### 9.2 质量验收

- Controller 层代码覆盖率达到 100%
- Service 层代码覆盖率达到 85% 以上
- 总体代码覆盖率达到 80% 以上
- 无严重的代码质量问题

### 9.3 文档验收

- 测试用例有清晰的说明
- 测试数据准备有文档记录
- 问题修复有记录和说明
- 生成测试报告和覆盖率报告

## 10. 交付物清单

| 交付物 | 说明 |
|-------|------|
| 测试代码 | 所有测试类和测试方法 |
| 测试配置 | application-test.yml 等配置文件 |
| 测试数据 | 测试数据初始化脚本 |
| 测试基类 | 通用测试基础设施 |
| 问题修复代码 | 测试中发现问题的修复 |
| 测试报告 | 测试执行结果和覆盖率报告 |
| 问题清单 | 发现的问题及修复状态 |
| 测试文档 | 测试执行指南和维护说明 |
